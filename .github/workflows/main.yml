name: Build NetHunter Kernel - A23

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  analyze-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: AnÃ¡lisis completo del repositorio
      id: analysis
      run: |
        echo "ðŸ” ANALIZANDO REPOSITORIO..."
        echo "============================"
        
        # Verificar estructura bÃ¡sica
        echo "ðŸ“ CONTENIDO DE LA RAÃZ:"
        ls -la
        
        echo ""
        echo "ðŸ“Š ARCHIVOS CLAVE:"
        echo "Makefile: $(if [ -f Makefile ]; then echo 'âœ… SÃ'; else echo 'âŒ NO'; fi)"
        echo "Kbuild: $(find . -name Kbuild -type f | head -1 | xargs basename 2>/dev/null || echo 'âŒ NO')"
        echo "Kconfig: $(find . -name Kconfig -type f | head -1 | xargs basename 2>/dev/null || echo 'âŒ NO')"
        echo "defconfig: $(find . -name '*defconfig' -type f | head -1 | xargs basename 2>/dev/null || echo 'âŒ NO')"
        
        echo ""
        echo "ðŸ“‹ EXTENSIONES DE ARCHIVOS:"
        find . -type f -name "*.*" | sed 's/.*\.//' | sort | uniq -c | sort -nr | head -5 || echo "No hay archivos con extensiones"
        
        echo ""
        echo "ðŸ“¦ TIPOS DE ARCHIVOS:"
        file $(find . -type f | head -10) 2>/dev/null || echo "No se pudo determinar tipos de archivo"

    - name: Instalar dependencias
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git bc bison flex libssl-dev make \
          gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi \
          libncurses-dev liblz4-tool python3 \
          zip unzip curl wget file

    - name: Intentar diferentes enfoques de compilaciÃ³n
      run: |
        echo "ðŸ”„ PROBANDO DIFERENTES MÃ‰TODOS..."
        echo "================================="
        
        # MÃ©todo 1: Buscar ANY Makefile en cualquier subdirectorio
        echo ""
        echo "1ï¸âƒ£ BUSCANDO CUALQUIER MAKEFILE..."
        MAKEFILES=$(find . -name Makefile -type f | head -5)
        if [ -n "$MAKEFILES" ]; then
          echo "âœ… Makefiles encontrados:"
          echo "$MAKEFILES"
          
          # Tomar el primer Makefile encontrado
          FIRST_MAKEFILE=$(echo "$MAKEFILES" | head -1)
          MAKEFILE_DIR=$(dirname "$FIRST_MAKEFILE")
          echo "ðŸ“ Usando directorio: $MAKEFILE_DIR"
          
          cd "$MAKEFILE_DIR"
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # Intentar compilar
          echo "ðŸ”¨ Intentando compilar en $MAKEFILE_DIR..."
          make -j2 || echo "âš ï¸ CompilaciÃ³n fallÃ³, pero continuamos..."
          
        else
          echo "âŒ No se encontrÃ³ ningÃºn Makefile"
        fi
        
        # Volver al directorio raÃ­z
        cd "$GITHUB_WORKSPACE"

        # MÃ©todo 2: Buscar archivos de kernel especÃ­ficos
        echo ""
        echo "2ï¸âƒ£ BUSCANDO ESTRUCTURA DE KERNEL..."
        if [ -d "arch/arm64" ]; then
          echo "âœ… Encontrado: arch/arm64/"
          echo "ðŸ“‹ Contenido de arch/arm64:"
          ls -la arch/arm64/ 2>/dev/null || echo "No se puede listar"
        else
          echo "âŒ No hay directorio arch/arm64"
        fi
        
        if [ -d "drivers" ]; then
          echo "âœ… Encontrado: drivers/"
        else
          echo "âŒ No hay directorio drivers"
        fi

    - name: Crear archivo de resultados
      run: |
        echo "ðŸ“Š CREANDO REPORTE FINAL..."
        mkdir -p results
        
        # Recopilar informaciÃ³n importante
        find . -name "Makefile" -o -name "*.c" -o -name "*.h" -o -name "*.dts" | head -20 > results/files-list.txt
        ls -la > results/root-contents.txt
        
        # Crear reporte
        cat > results/REPORT.md << EOF
        # Reporte del Repositorio A23kernetnh
        
        ## AnÃ¡lisis
        - **Fecha**: $(date)
        - **Commit**: $GITHUB_SHA
        - **URL**: https://github.com/$GITHUB_REPOSITORY
        
        ## Estructura
        \`\`\`
        $(find . -type d | sort | head -20)
        \`\`\`
        
        ## Recomendaciones
        $(if [ -f Makefile ]; then 
          echo "- âœ… Tiene Makefile en raÃ­z - puede ser un kernel"
          echo "- ðŸ’¡ Configurar GitHub Actions para compilaciÃ³n normal"
        elif [ -n "$(find . -name Makefile -type f)" ]; then
          echo "- âš ï¸ Tiene Makefile en subdirectorios - estructura inusual"
          echo "- ðŸ’¡ Especificar ruta exacta del Makefile en el workflow"
        else
          echo "- âŒ NO tiene Makefile - no es un Ã¡rbol de kernel estÃ¡ndar"
          echo "- ðŸ’¡ Considerar:"
          echo "  1. Agregar un Makefile si es un kernel"
          echo "  2. Usar un repositorio base de kernel y aplicar cambios"
          echo "  3. Reestructurar el proyecto"
        fi)
        EOF
        
        # Crear ZIP con resultados
        zip -r repository-analysis.zip results/

    - name: Subir artifacts de anÃ¡lisis
      uses: actions/upload-artifact@v4
      with:
        name: repository-analysis
        path: |
          repository-analysis.zip
          results/
        retention-days: 30

    - name: Mostrar conclusiÃ³n
      run: |
        echo ""
        echo "ðŸŽ¯ CONCLUSIÃ“N"
        echo "============="
        if [ -f Makefile ]; then
          echo "âœ… Este repositorio TIENE Makefile en raÃ­z"
          echo "ðŸ’¡ Puede ser compilado como kernel normal"
        elif [ -n "$(find . -name Makefile -type f)" ]; then
          echo "âš ï¸ Este repositorio tiene Makefile en subdirectorios"
          echo "ðŸ’¡ Necesita configuraciÃ³n especial en GitHub Actions"
        else
          echo "âŒ Este repositorio NO TIENE Makefile"
          echo "ðŸ’¡ No es un Ã¡rbol de kernel Linux estÃ¡ndar"
          echo ""
          echo "ðŸ“ OPCIONES:"
          echo "1. Si es cÃ³digo de kernel, agregar Makefile"
          echo "2. Si son parches, aplicar sobre kernel base"
          echo "3. Si es otro tipo de proyecto, reconsiderar el enfoque"
        fi
